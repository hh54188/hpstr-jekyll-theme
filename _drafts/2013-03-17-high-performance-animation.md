# Javascript高性能动画

**不确定的地方:**

- 浏览器（不是javascript）真的是单线程的吗？有没有参考？

## No setTimeout, No setInterval

这篇文章不仅仅谈动画，更主要想谈谈浏览器的渲染，以及如果保证这两者的高效，如何在性能方面作出一些优化。

如果你一定要使用`setTimeout`或者`setInterval`来实现动画，那么原因只能有一个，就是需要精确的控制动画。之所以浏览器兼容问题在我看来不考虑是因为，至少在现在这个时间点，高级浏览器的普及程度足够让你有理由、也应该、同时也有空间在实现动画时使用更高效的方式。 

为什么不推荐使用`setTimeout`/`setInterval`？这要从我们的需求谈起。

### 什么样的动画才算是高效的

这里的高效翻译过来就是流畅，我们需要的是流程的动画？那实现动画的效率就不考虑了吗？傻瓜，你觉得用低效率实现的动画能保证动画的流程吗？

流畅的动画和流畅的网页原理是一样的，要知道网页的每一帧变化都是浏览器绘制出来的。如果你对PC游戏有了解的话，就应该能想到最佳的绘制频率应该是每秒60帧(60fps)，当然30fps也是可以接受的，至少人的视觉几乎察觉不到任何的差别。帧数在页面的性能调试中是一个非常重要的衡量指标。在Chrome的调试工具Devtools中，随处可见FPS的踪影：

![frames](./images/fps.jpg)

接下来的工作中，我们将会用到这些工具，来实时查看我们页面的性能。

我们的目标已经有了，每秒绘制60帧。但坏消息也随之而来，因为这也意味着，留给每帧绘制的时间只有 1000 / 60 = 16.7ms。这时间当然远远不够，说浏览器是单线程(single thread)并不准确，但大部分情况下，页面的重排(reflow)、重绘(repaint)，脚本的运行、甚至垃圾回收(garbage collector)都是相互排斥的(所以你在timeline中看到的是瀑布图)，也就是在任意一个时刻，只允许其中的一项任务在运行。

如果这点还不足以说明问题的话，那么再退一步，即使动画需要执行的所有任务都能在16.7ms内完成。是不是动画

