## 前言

上周有幸和淘宝前端团队的七念老师做了一些NodeJS方面上的交流（实际情况其实是他电话面试了我……），我们主要聊到了我参与维护的一个线上NodeJS服务，关于它的现状和当下的不足。他向我提出的一些问题带给了我很大启发，尽管我回答的不好。简单来说问题就是，对于你意识到的这些不足，你将尝试怎样去改进它们？再发散一些的说，如果给你一个机会来重新设计这个系统服务，你将如何做？相比现在有什么的改进？

为什么说这些问题对我产生了启发，是因为这些问题是我不曾考虑过的。或者说考虑过，但没有这么严肃的考虑过。这里的“严肃”指的是具体到企业级，线上，细节等方面。而我在尝试回答这些问题，在寻找答案的过程中又发现一片新的天地，收获了不少新的知识。

这篇文章与以往的文章不同，并不是阐述某一个问题的最佳解决方案。而是分享在探寻答案过程中收获的心得、留下的困惑还有一点个人的经验。至于这些能否拿来回答最初的那些问题我没有十足的把握，能，但不是最佳答案。因为后端架构实在一个很有深度的话题，也是一个极其成熟的技术方向。即使有了理论方面的积累，面对千变万化的业务需求难免还是灵活的对方案进行改进，而无论是理论还是实践经验都是我欠缺的。

这段话本来应该是写在结尾的话感觉顺嘴也就挂在了开头，最后想说，还是老祖宗说的好：纸上得来终觉浅，绝知此事要躬行。

## 正文

一个怎样的后端服务才能算得上优秀？或者放低一点说合格？再把这个问题翻译翻译，优秀或者合格的标准是什么？

假设现在需要你用NodeJS搭建一个http服务，我猜测你会借助express框架用不到10行的代码完成这项工作。不能说这么做是错的，但这样简易的程序是脆弱的：一旦部署上线之后，可能瞬间就被大量涌入的请求击垮，更不要提各种潜在的漏洞危险。退一步说，即使线上程序经过了这一关考验，如果你要更新程序怎么办？不得不让用户中断访问一段时间？

在我看来，后端服务务必要满足两条特性：

- 能容错（fault tolerant）
- 可扩展（scalability）

当然还有一些其他特性也很重要，比如程序要健壮，接口设计要友好，程序修改起来要灵活等等。但容错性和拓展性才是正常运行的基本保障，至少保证了你的服务是可用的，永远是可用的。而无论实现服务的代码如何优雅，它都是为业务服务的，一旦用户无法访问你的服务了，再优美的代码也无济于事。所以接下来的问题就是，我们后端程序的架构如何的设计以保证满足这两条特性。

以下的部分内容和图片参考自图书：Node.js design patterns。如有雷同，不是巧合。

首先我们说说拓展性（scalability）。

按照书中的说法，拓展性划分为三类，如下图所示：

![type of scalability](./images/something-about-nodejs-architecture/type-of-scale.png)

- X轴方向：纯粹的对服务实例进行拓展，例如为了响应更多的请求
- y轴方向：为服务添加新的功能，功能性拓展
- z轴方向：按照业务数据对服务进行拓展（这里没搞懂，不知道这么说是否准确）

而通常实际的拓展过程中多维度是同时进行的，例如增添了新的功能也就意味着有跟多的流量进入，也就是意味着需要增加新的服务实例。

我们先谈第
